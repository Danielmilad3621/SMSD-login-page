# Phase 3 Plan — Meeting Management

**Phase:** 3  
**Wave:** 1  
**Goal:** Enable leaders to create and manage meeting records

## Requirements Covered

- MEET-01: Admin/Admin Leader can create new meeting (date, location required)
- MEET-02: Admin/Admin Leader can edit meeting details (before attendance taken)
- MEET-03: Admin/Admin Leader can view list of all meetings (past and future)
- MEET-04: System displays meetings in chronological order (upcoming first)
- MEET-05: System prevents creating meetings with duplicate dates
- MEET-06: Admin/Admin Leader can assign leaders to meeting (at least one required)
- PERM-04: Admin Leaders can create meetings

## Tasks

### Task 1: Update Database Schema

**Objective:** Add scout_groups field to meetings table

**Steps:**
1. Create migration to add `scout_groups` field
   - Add `scout_groups TEXT[] DEFAULT ARRAY[]::TEXT[]` to meetings table
   - Add GIN index on scout_groups for performance
   - Add comment explaining the field

2. Update meetings table structure
   - Keep existing fields: id, date, location, type, assigned_leaders, created_at, updated_at
   - Add: scout_groups (TEXT[] array)
   - Note: type field exists but not used in v1

3. Apply migration to Supabase
   - Use Supabase migration tool or SQL Editor
   - Verify field added correctly

**Verification:**
- scout_groups field exists in meetings table
- GIN index created on scout_groups
- Migration applied successfully

**Files to create:**
- `supabase/migrations/006_add_meeting_scout_groups.sql`

---

### Task 2: Add Meetings Screen & Navigation

**Objective:** Add meetings management screen and navigation

**Steps:**
1. Add meetings screen to `index.html`
   - `#meetings-screen` - Meetings management screen
   - Screen header with back button and title
   - Screen content area

2. Add "Meetings" to navigation menu
   - Add "Meetings" button to nav menu in `#logged-in` screen
   - Only visible to Admin/Admin Leader
   - Active state styling

3. Update screen transition logic in `app.js`
   - Add `meetings` to screens object
   - Add navigation handler for meetings button
   - Add back button handler

4. Add permission check
   - Use existing `canManageParticipants()` function
   - Show/hide navigation based on role

**Verification:**
- Meetings screen renders correctly
- Navigation works (Meetings button, back button)
- Navigation only visible to Admin/Admin Leader
- Screen transitions smooth

**Files to modify:**
- `index.html` - Add meetings screen HTML
- `app.js` - Add navigation logic
- `styles.css` - Navigation styles already exist

---

### Task 3: Build Meetings List Screen

**Objective:** Display meetings grouped by week, upcoming first

**Steps:**
1. Create meetings list container in `#meetings-screen`
   - "Add Meeting" button (only Admin/Admin Leader)
   - Loading state
   - Error state
   - List container with week sections
   - Empty states (no upcoming, no past)

2. Implement data fetching
   - `loadMeetings()` - Fetch meetings from Supabase
   - Handle RLS filtering (user sees only their groups)
   - Sort: upcoming first (date >= today), then past (date < today)
   - Within each section: chronological order

3. Implement week grouping
   - `groupMeetingsByWeek()` - Group meetings by week (Monday-Sunday)
   - Calculate week boundaries
   - Label weeks: "This Week", "Next Week", "Week of [Monday date]"
   - Past weeks: "Last Week", "Week of [Monday date]"

4. Render meetings list
   - Group by week
   - Show week header
   - Render meeting cards within each week
   - Show empty state if no meetings

5. Add loading states
   - Loading spinner while fetching
   - Error message if fetch fails

**Verification:**
- Meetings list displays correctly
- Meetings grouped by week
- Upcoming meetings first, then past
- Week labels correct
- Empty states shown when no meetings
- Loading/error states work

**Files to modify:**
- `index.html` - Add meetings screen HTML
- `app.js` - Add meetings list logic, week grouping function
- `styles.css` - Week header styles (can reuse group-header)

---

### Task 4: Build Meeting Card Component

**Objective:** Display meeting information in card format

**Steps:**
1. Create meeting card HTML structure
   - Card with: date (formatted), location, scout groups, assigned leaders, attendance count
   - Edit button (if user can edit and no attendance taken)
   - "Attendance taken" indicator (if attendance exists)

2. Implement date formatting
   - Format: "Monday, January 15, 2025" or "Jan 15, 2025"
   - Use JavaScript Date formatting

3. Implement leader display
   - Fetch leader names and emails from leaders table
   - Format: "John Doe (john@example.com), Jane Smith (jane@example.com)"
   - Or: "Assigned: John Doe, Jane Smith" with emails on hover

4. Implement attendance count
   - Query attendance table: `SELECT COUNT(*) FROM attendance WHERE meeting_id = ?`
   - Count present and absent
   - Display: "12 present, 3 absent" or "15/18 attended"
   - Show "No attendance taken" if count is 0

5. Implement edit button visibility
   - Show if user is Admin/Admin Leader AND no attendance taken
   - Hide if attendance exists or user cannot edit

6. Render meeting cards
   - Call `renderMeetingCard()` for each meeting
   - Attach event listeners for edit button

**Verification:**
- Meeting cards display correctly
- Date formatted properly
- Leaders displayed with names and emails
- Attendance count accurate
- Edit button shows/hides correctly
- "Attendance taken" indicator works

**Files to modify:**
- `app.js` - Add meeting card rendering, date formatting, attendance count logic
- `styles.css` - Meeting card styles (can reuse participant-card)

---

### Task 5: Build Add Meeting Form

**Objective:** Form to create new meeting with validation

**Steps:**
1. Create add meeting modal form in `index.html`
   - Modal overlay and modal container
   - Form fields: date, location, scout groups (checkboxes), assigned leaders (multi-select), notes
   - Submit and Cancel buttons

2. Implement date picker
   - HTML5 date input with `min` attribute (today's date)
   - Disable past dates
   - Real-time validation

3. Implement scout group selection
   - Checkboxes for Group 1 and Group 2
   - At least one required (validation)
   - Error message if none selected

4. Implement leader multi-select
   - Fetch all active leaders
   - Multi-select dropdown or checkboxes
   - Display: leader name and email
   - At least one leader required (validation)

5. Implement duplicate date check
   - On date change or form submit
   - Query: `SELECT * FROM meetings WHERE date = selected_date`
   - Show error: "A meeting already exists on this date"
   - Prevent form submission if duplicate

6. Implement form validation
   - Date: Required, future date only
   - Location: Required, non-empty
   - Scout groups: At least one required
   - Assigned leaders: At least one required
   - Real-time validation (on blur or after typing)

7. Implement error display
   - Inline errors under each field
   - Error banner at top of form
   - Clear errors on field change

8. Implement form submission
   - `addMeeting()` - Insert into Supabase meetings table
   - Include: date, location, scout_groups (array), assigned_leaders (array), notes
   - Handle success: Show success message, redirect to meetings list
   - Handle error: Show error banner
   - Loading state during submission

9. Add form reset
   - Clear form after successful submission
   - Reset validation state

**Verification:**
- Form displays correctly
- Date picker works (future dates only)
- Validation works (required fields, duplicate date)
- Duplicate date prevented
- Error messages display correctly
- Form submits successfully
- Redirects to list after add
- Loading states work

**Files to modify:**
- `index.html` - Add add meeting modal HTML
- `app.js` - Add form validation, submission logic, duplicate check
- `styles.css` - Form styles already exist

---

### Task 6: Build Edit Meeting Functionality

**Objective:** Inline edit for meeting information (if no attendance taken)

**Steps:**
1. Add edit button to meeting card
   - Only visible to Admin/Admin Leader
   - Only visible if no attendance taken
   - Click handler to enable edit mode

2. Implement attendance check
   - `checkMeetingAttendance()` - Query attendance table
   - `SELECT COUNT(*) FROM attendance WHERE meeting_id = ?`
   - Return boolean: true if attendance exists

3. Implement inline edit form
   - Convert card to editable form
   - Fields: date, location, scout groups (checkboxes), assigned leaders (multi-select), notes
   - Same validation as add form
   - Show warning if attempting to edit with attendance

4. Implement edit validation
   - Same validation as add form
   - Check duplicate date (exclude current meeting)
   - Real-time validation

5. Implement edit submission
   - `updateMeeting()` - Update meeting in Supabase
   - Handle success: Update card in place, exit edit mode
   - Handle error: Show error message
   - Loading state during update

6. Implement cancel edit
   - Revert to original values
   - Exit edit mode
   - Clear validation errors

7. Block editing if attendance taken
   - Check attendance before showing edit form
   - If attendance exists, show message: "Cannot edit meeting - attendance has already been taken"
   - Do not show edit form

**Verification:**
- Edit button works
- Attendance check works correctly
- Inline edit form appears (if no attendance)
- Editing blocked if attendance taken
- Validation works
- Update successful
- Card updates in place
- Cancel works correctly

**Files to modify:**
- `app.js` - Add edit logic, update function, attendance check
- `styles.css` - Edit mode styles already exist

---

### Task 7: Add Permission Checks & UI Hiding

**Objective:** Hide features based on user role

**Steps:**
1. Implement permission checks
   - Use existing `canManageParticipants()` function
   - Check if user is Admin or Admin Leader

2. Hide UI elements based on role
   - "Add Meeting" button: Only Admin/Admin Leader
   - Edit buttons on cards: Only Admin/Admin Leader (and no attendance)
   - Navigation "Meetings" button: Only Admin/Admin Leader

3. Show appropriate messages
   - Viewers/Leaders: Read-only access (if they can see meetings)
   - Show "Attendance taken" indicator on cards

4. Test permission enforcement
   - Test as Admin (full access)
   - Test as Admin Leader (full access)
   - Test as Leader (read-only, if applicable)
   - Test as Viewer (read-only, if applicable)

**Verification:**
- Permission checks work correctly
- UI elements hidden/shown based on role
- All role scenarios tested

**Files to modify:**
- `app.js` - Add permission checks, UI hiding logic
- `index.html` - Add conditional classes/data attributes

---

## Success Criteria

1. ✅ Admin/Admin Leader can create new meeting (date, location, scout groups, leaders)
2. ✅ Admin/Admin Leader can edit meeting details (if no attendance taken)
3. ✅ Admin/Admin Leader can view list of all meetings
4. ✅ Meetings displayed in chronological order (upcoming first, grouped by week)
5. ✅ System prevents creating meetings with duplicate dates
6. ✅ Admin/Admin Leader can assign leaders to meeting (at least one required)
7. ✅ Meetings display with date, location, assigned leaders, attendance count
8. ✅ Editing blocked if attendance has been taken
9. ✅ Week grouping works correctly
10. ✅ Permission enforcement works

## Verification Checklist

- [ ] Database migration applied (scout_groups field added)
- [ ] Meetings screen renders correctly
- [ ] Navigation works (Meetings button, back button)
- [ ] Meetings list displays with week grouping
- [ ] Upcoming meetings first, then past
- [ ] Meeting cards show all information
- [ ] Add meeting form validates correctly
- [ ] Duplicate date prevented
- [ ] Edit meeting works (inline edit)
- [ ] Editing blocked if attendance taken
- [ ] Leader assignment works (multi-select)
- [ ] Permission checks work (UI hiding)
- [ ] Week labels correct ("This Week", "Next Week", etc.)
- [ ] Attendance count displayed correctly

## Notes

- **Database Migration:** Need to add scout_groups field to meetings table
- **Week Grouping:** Monday-Sunday boundaries, calculate week labels dynamically
- **Date Handling:** Use DATE type (no time), format for display
- **Attendance Check:** Query attendance table before allowing edit
- **Leader Display:** Fetch leader details from leaders table to show names/emails
- **Duplicate Prevention:** Check on date change and form submit
- **Permission:** Use existing permission check functions

## Dependencies

- Phase 1 complete (database schema, RLS policies)
- Phase 2 complete (leaders exist for assignment)
- Supabase client initialized (existing)
- User authenticated (existing)

## Estimated Effort

- Task 1 (Database Migration): 30 minutes
- Task 2 (Screen & Navigation): 1 hour
- Task 3 (Meetings List): 2-3 hours
- Task 4 (Meeting Card): 1-2 hours
- Task 5 (Add Form): 2-3 hours
- Task 6 (Edit Functionality): 2-3 hours
- Task 7 (Permissions): 30 minutes

**Total:** 9-13 hours

---
*Plan created: 2025-02-09*  
*Ready for execution*

