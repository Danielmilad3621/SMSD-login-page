# Phase 4 Plan — Attendance Taking

**Phase:** 4  
**Wave:** 1  
**Goal:** Enable leaders to mark attendance (Present/Absent) for scouts and leaders

## Requirements Covered

- ATTEND-01: Leader can mark scout as Present for a meeting
- ATTEND-02: Leader can mark scout as Absent for a meeting
- ATTEND-03: Leader can mark other leader as Present for a meeting
- ATTEND-04: Leader can mark other leader as Absent for a meeting
- ATTEND-05: System saves attendance immediately on change (no submit button)
- ATTEND-06: System provides visual feedback (checkmark/color) for marked attendance
- ATTEND-07: System displays all scouts for selected meeting in attendance screen
- ATTEND-08: System displays all leaders for selected meeting in attendance screen
- ATTEND-09: System prevents duplicate attendance records (one record per scout per meeting)
- ATTEND-10: System handles errors gracefully (shows message, allows retry)
- PERM-05: Leaders can take attendance

## Tasks

### Task 1: Add Attendance Screen & Navigation

**Objective:** Create attendance taking screen and add navigation

**Steps:**
1. Add attendance screen to `index.html`
   - `#attendance-screen` - Attendance taking screen
   - Screen header with back button and title
   - Screen content area

2. Add "Take Attendance" button to meetings list
   - Add button to each meeting card (if no attendance taken)
   - Or add "Take Attendance" to navigation menu
   - Only visible to Admin/Admin Leader/Leader (not Viewers)

3. Update screen transition logic in `app.js`
   - Add `attendance` to screens object
   - Add navigation handler for attendance button
   - Add back button handler

4. Add permission check
   - Use existing permission functions
   - Leaders can take attendance (PERM-05)
   - Viewers: Read-only (no attendance button)

**Verification:**
- Attendance screen renders correctly
- Navigation works (Take Attendance button, back button)
- Navigation only visible to appropriate roles
- Screen transitions smooth

**Files to modify:**
- `index.html` - Add attendance screen HTML
- `app.js` - Add navigation logic
- `styles.css` - Screen styles already exist

---

### Task 2: Build Meeting Selection (Calendar + List)

**Objective:** Calendar view with list below for meeting selection

**Steps:**
1. Create calendar component
   - Simple calendar grid (month view)
   - Highlight dates with meetings
   - Clickable dates (only today and future)
   - Show current month, navigation to next/previous month

2. Create meetings list below calendar
   - List of upcoming meetings (today and future)
   - Show date, location, groups
   - Clickable to select meeting
   - Highlight selected meeting

3. Implement meeting selection
   - Click date in calendar → select meeting for that date
   - Click meeting in list → select that meeting
   - Store selected meeting ID
   - Load attendance data for selected meeting

4. Filter meetings by date
   - Only show meetings for today and future
   - Hide past meetings from selection
   - Validate: Cannot take attendance for past meetings

5. Display selected meeting info
   - Show meeting date (formatted)
   - Show meeting location
   - Show scout groups
   - Show assigned leaders
   - Read-only information display

**Verification:**
- Calendar displays correctly
- Dates with meetings are highlighted
- List shows upcoming meetings
- Meeting selection works (calendar and list)
- Selected meeting info displays
- Past meetings filtered out

**Files to modify:**
- `index.html` - Add calendar and list HTML
- `app.js` - Add calendar logic, meeting selection
- `styles.css` - Add calendar styles

---

### Task 3: Build Attendance List (Scouts Section)

**Objective:** Display scouts for selected meeting with attendance controls

**Steps:**
1. Create scouts section in attendance screen
   - Header: "Scouts"
   - List container for scouts

2. Implement data loading
   - `loadScoutsForMeeting()` - Fetch scouts for meeting
   - Filter by meeting's scout_groups
   - If meeting has "Group 1", show only Group 1 scouts
   - If meeting has both groups, show all scouts from both groups
   - Sort: Group 1 first, then Group 2, alphabetical within group

3. Load existing attendance records
   - Query attendance table for this meeting
   - Map attendance status to each scout
   - Show existing status if attendance already taken

4. Create scout list item component
   - Name
   - Present/Absent toggle (or checkboxes)
   - Activity points input (number field)
   - Loading indicator
   - Success/error feedback area

5. Render scouts list
   - Group by scout_group
   - Show group header if multiple groups
   - Render list items alphabetically within group
   - Show existing attendance status if available

6. Handle empty state
   - Show "No scouts found" if no scouts for meeting's groups
   - Show message if meeting has no scout groups assigned

**Verification:**
- Scouts list displays correctly
- Only scouts from meeting's groups shown
- Existing attendance status displayed
- Grouped by scout group
- Empty state shown when no scouts

**Files to modify:**
- `index.html` - Add scouts section HTML
- `app.js` - Add scouts loading and rendering logic
- `styles.css` - Add list item styles

---

### Task 4: Build Attendance List (Leaders Section)

**Objective:** Display leaders for selected meeting with attendance controls

**Steps:**
1. Create leaders section in attendance screen
   - Header: "Leaders"
   - List container for leaders

2. Implement data loading
   - `loadLeadersForMeeting()` - Fetch leaders for meeting
   - Filter by meeting's scout_groups
   - Show only active leaders
   - Sort: Alphabetical by name

3. Load existing attendance records
   - Query attendance table for this meeting (for leaders)
   - Map attendance status to each leader
   - Show existing status if attendance already taken

4. Create leader list item component
   - Name
   - Present/Absent toggle (or checkboxes)
   - Activity points input (number field, but note: leaders don't accumulate points)
   - Loading indicator
   - Success/error feedback area

5. Render leaders list
   - Render list items alphabetically
   - Show existing attendance status if available

6. Handle empty state
   - Show "No leaders found" if no leaders for meeting's groups

**Verification:**
- Leaders list displays correctly
- Only leaders from meeting's groups shown
- Existing attendance status displayed
- Empty state shown when no leaders

**Files to modify:**
- `index.html` - Add leaders section HTML
- `app.js` - Add leaders loading and rendering logic
- `styles.css` - List item styles already exist

---

### Task 5: Build Attendance Toggle Component

**Objective:** Present/Absent toggle with visual feedback

**Steps:**
1. Create toggle component
   - Three states: Unmarked, Present, Absent
   - Visual indicators: Checkmark for Present, X for Absent, neutral for Unmarked
   - Large tap target (44x44px minimum)

2. Implement toggle interaction
   - Click unmarked → Present
   - Click Present → Absent
   - Click Absent → Present (or back to unmarked?)
   - Decision: Present → Absent → Present (cycle)

3. Add visual feedback
   - Present: Green checkmark (✓) or green background
   - Absent: Red X (✗) or red background
   - Unmarked: Gray/neutral state
   - Use CSS classes for styling

4. Implement auto-save on toggle
   - On toggle change, immediately call save function
   - Show loading state while saving
   - Disable toggle during save
   - Show success feedback on save
   - Show error feedback on failure

5. Handle existing attendance
   - If attendance already exists, show current status
   - Disable toggle if attendance already saved (no editing)
   - Show "Attendance saved" indicator

**Verification:**
- Toggle displays correctly (three states)
- Toggle interaction works
- Visual feedback correct (colors, icons)
- Auto-save triggers on change
- Loading state shows during save
- Success/error feedback works

**Files to modify:**
- `index.html` - Add toggle HTML structure
- `app.js` - Add toggle logic, auto-save function
- `styles.css` - Add toggle styles, state colors

---

### Task 6: Implement Attendance Save Function

**Objective:** Save attendance records with auto-save and error handling

**Steps:**
1. Create save attendance function
   - `saveAttendance()` - Save attendance record
   - Parameters: scout_id or leader_id, meeting_id, status, activity_points
   - Use UPSERT pattern (INSERT ... ON CONFLICT DO UPDATE)

2. Implement UPSERT logic
   - Check if attendance record exists
   - If exists: UPDATE status and points_earned
   - If not exists: INSERT new record
   - Use Supabase upsert or manual check

3. Calculate points_earned
   - Base: 1 point if Present, 0 if Absent
   - Activity points: Add to base
   - Total: points_earned = (Present ? 1 : 0) + activity_points

4. Update scout's points_total
   - If Present: UPDATE scouts SET points_total = points_total + points_earned
   - If Absent: No points update
   - Use atomic SQL operation

5. Handle errors
   - Catch save errors
   - Show error message inline
   - Keep toggle in attempted state
   - Allow retry

6. Implement retry mechanism
   - Retry button or click toggle again
   - Show loading during retry
   - Clear error on success

7. Handle offline state
   - Detect offline status
   - Show error if offline
   - Allow retry when connection restored

**Verification:**
- Attendance saves correctly (INSERT or UPDATE)
- Points calculated correctly
- points_total updates correctly
- Errors handled gracefully
- Retry works
- Offline detection works

**Files to modify:**
- `app.js` - Add save attendance function, error handling, retry logic

---

### Task 7: Implement Activity Points Input

**Objective:** Activity points input field for each attendee

**Steps:**
1. Add activity points input to list items
   - Number input field
   - Integer only (no decimals)
   - Minimum: 0
   - Optional (can be empty or 0)

2. Implement input validation
   - Only allow positive integers
   - Show error if invalid input
   - Clear error on valid input

3. Implement auto-save on blur
   - Save activity points when input loses focus
   - Or save on Enter key
   - Update attendance record with new points_earned
   - Update scout's points_total

4. Handle points recalculation
   - If attendance is Present: points_earned = 1 + activity_points
   - If attendance is Absent: points_earned = 0 + activity_points (still 0)
   - Update attendance record
   - Update scout's points_total (difference only)

5. Show loading state
   - Loading indicator while saving activity points
   - Disable input during save
   - Show success feedback

6. Handle errors
   - Show error message if save fails
   - Allow retry
   - Keep input value on error

**Verification:**
- Activity points input displays correctly
- Validation works (integers only)
- Auto-save on blur/Enter works
- Points recalculated correctly
- Loading/success/error states work

**Files to modify:**
- `index.html` - Add activity points input to list items
- `app.js` - Add activity points save logic
- `styles.css` - Input field styles already exist

---

### Task 8: Add Visual Feedback & Loading States

**Objective:** Loading, success, and error feedback for each action

**Steps:**
1. Implement loading indicators
   - Per-row loading spinner
   - Show while saving attendance
   - Show while saving activity points
   - Disable controls during loading

2. Implement success feedback
   - Inline "Saved" message or checkmark
   - Fade out after 2-3 seconds
   - Per-row success indicator
   - Green color for success

3. Implement error feedback
   - Inline error message
   - Red color for errors
   - Error icon or "Failed to save" text
   - Retry button or click to retry

4. Add state management
   - Track saving state per attendee
   - Track success/error state per attendee
   - Clear states appropriately

5. Style feedback elements
   - Loading spinner animation
   - Success message styling
   - Error message styling
   - Smooth transitions

**Verification:**
- Loading indicators show during save
- Success feedback displays and fades
- Error feedback displays with retry
- States managed correctly
- Styling looks good

**Files to modify:**
- `app.js` - Add state management, feedback logic
- `styles.css` - Add loading, success, error styles

---

### Task 9: Handle Existing Attendance & Edit Prevention

**Objective:** Show existing attendance and prevent editing

**Steps:**
1. Load existing attendance on screen load
   - Query attendance table for selected meeting
   - Map attendance to scouts and leaders
   - Display existing status

2. Disable editing if attendance exists
   - If attendance record exists, disable toggle
   - Show "Attendance saved" indicator
   - Prevent changes (no toggle interaction)

3. Show read-only indicator
   - Visual indicator that attendance is saved
   - Message: "Attendance already taken" or similar
   - Different styling for saved vs unsaved

4. Handle edge cases
   - What if attendance exists but status is null?
   - What if attendance exists for some but not all?
   - Show appropriate state for each

**Verification:**
- Existing attendance loads correctly
- Saved attendance shows as read-only
- Toggle disabled for saved attendance
- Edge cases handled

**Files to modify:**
- `app.js` - Add existing attendance loading, edit prevention logic
- `styles.css` - Add read-only styles

---

### Task 10: Add Permission Checks & Mobile Optimization

**Objective:** Ensure proper permissions and mobile-friendly UX

**Steps:**
1. Implement permission checks
   - Check if user can take attendance (Admin, Admin Leader, Leader)
   - Hide attendance controls for Viewers
   - Filter meetings by user's groups (for Leaders)

2. Optimize for mobile
   - Large tap targets (44x44px minimum)
   - Fast loading (optimize queries)
   - Responsive layout
   - Touch-friendly interactions

3. Test mobile UX
   - Test on mobile device or emulator
   - Verify tap targets are large enough
   - Verify loading is fast
   - Verify layout works on small screens

4. Add loading optimizations
   - Batch queries where possible
   - Cache data where appropriate
   - Show loading states immediately
   - Optimize database queries

**Verification:**
- Permission checks work correctly
- Mobile UX is good (large tap targets, fast loading)
- Layout responsive
- Queries optimized

**Files to modify:**
- `app.js` - Add permission checks, mobile optimizations
- `styles.css` - Ensure mobile-friendly styles

---

## Success Criteria

1. ✅ Leader can mark scout as Present/Absent for selected meeting
2. ✅ Leader can mark other leader as Present/Absent for selected meeting
3. ✅ System saves attendance immediately on change (no submit button)
4. ✅ System provides clear visual feedback (checkmark/color) for marked attendance
5. ✅ System displays all scouts and leaders for selected meeting (filtered by groups)
6. ✅ System prevents duplicate attendance records (one per scout per meeting)
7. ✅ System handles errors gracefully (shows message, allows retry)
8. ✅ Attendance screen is mobile-friendly (large tap targets, fast loading)
9. ✅ Attendance data persists in Supabase
10. ✅ Points calculated and updated immediately
11. ✅ Activity points can be entered and saved
12. ✅ Existing attendance shown and editing prevented

## Verification Checklist

- [ ] Attendance screen renders correctly
- [ ] Calendar displays with meetings highlighted
- [ ] Meetings list shows upcoming meetings
- [ ] Meeting selection works (calendar and list)
- [ ] Scouts list displays (filtered by meeting's groups)
- [ ] Leaders list displays (filtered by meeting's groups)
- [ ] Attendance toggle works (Present/Absent)
- [ ] Auto-save triggers on toggle change
- [ ] Activity points input works
- [ ] Activity points save on blur/Enter
- [ ] Points calculated correctly
- [ ] points_total updates immediately
- [ ] Loading states show during save
- [ ] Success feedback displays
- [ ] Error handling works (retry)
- [ ] Existing attendance loads and displays
- [ ] Editing prevented for saved attendance
- [ ] Permission checks work
- [ ] Mobile-friendly (large tap targets)

## Notes

- **Calendar Implementation:** Simple month view calendar (can use library or build custom)
- **Toggle vs Checkboxes:** Use single toggle for cleaner UX (Present ↔ Absent)
- **Activity Points:** Only scouts accumulate points_total, leaders don't
- **Points Update:** Use atomic SQL operations to prevent race conditions
- **Auto-Save:** Each toggle change triggers immediate save (no batching)
- **Error Handling:** Per-row error messages with retry
- **Mobile:** Large tap targets, fast loading, responsive layout

## Dependencies

- Phase 1 complete (database schema, RLS policies)
- Phase 2 complete (scouts and leaders exist)
- Phase 3 complete (meetings exist)

## Estimated Effort

- Task 1 (Screen & Navigation): 1 hour
- Task 2 (Meeting Selection): 3-4 hours
- Task 3 (Scouts List): 2-3 hours
- Task 4 (Leaders List): 1-2 hours
- Task 5 (Toggle Component): 2-3 hours
- Task 6 (Save Function): 2-3 hours
- Task 7 (Activity Points): 2-3 hours
- Task 8 (Visual Feedback): 1-2 hours
- Task 9 (Edit Prevention): 1 hour
- Task 10 (Permissions & Mobile): 1-2 hours

**Total:** 16-24 hours

---
*Plan created: 2025-02-09*  
*Ready for execution*

