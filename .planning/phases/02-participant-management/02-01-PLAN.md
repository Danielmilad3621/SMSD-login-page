# Phase 2 Plan — Participant Management

**Phase:** 2  
**Wave:** 1  
**Goal:** Enable leaders to add and manage scouts and leaders in the system

## Requirements Covered

- PART-01: Admin/Admin Leader can add new scout to system
- PART-02: Admin/Admin Leader can edit scout information
- PART-03: Admin/Admin Leader can view list of all scouts
- PART-04: Admin/Admin Leader can search/filter scouts by name
- PART-05: System displays scout's total points alongside name in lists
- PART-06: Admin/Admin Leader can add new leader to system
- PART-07: Admin/Admin Leader can view list of all leaders
- PART-08: System prevents duplicate scouts (same email)
- PERM-03: Admin has full system access (all features)
- PERM-04: Admin Leaders can create meetings and take attendance

## Tasks

### Task 1: Create Navigation & Screen Structure

**Objective:** Add new screens for Scouts and Leaders management, extend navigation

**Steps:**
1. Add new screen sections to `index.html`
   - `#scouts-screen` - Scouts management screen
   - `#leaders-screen` - Leaders management screen
   - Update `#logged-in` screen to include navigation menu

2. Create navigation menu component
   - Tabs/buttons: "Scouts", "Leaders" (only visible to Admin/Admin Leader)
   - Active state styling
   - Hide navigation for Viewers (read-only, different UI later)

3. Update screen transition logic in `app.js`
   - Add `scouts` and `leaders` to screens object
   - Extend `showScreen()` to handle new screens
   - Add navigation handlers

4. Add permission check function
   - `getUserRole()` - Query roles table to get current user's role
   - `canManageParticipants()` - Check if user is Admin or Admin Leader
   - Use in navigation visibility logic

**Verification:**
- New screens render correctly
- Navigation works between screens
- Navigation only visible to Admin/Admin Leader
- Screen transitions smooth (CSS animations)

**Files to modify:**
- `index.html` - Add new screen sections
- `app.js` - Add navigation logic, permission checks
- `styles.css` - Add navigation styles, screen styles

---

### Task 2: Build Scouts List Screen

**Objective:** Display scouts in card format, grouped by scout group, with search/filter

**Steps:**
1. Create scouts list container in `#scouts-screen`
   - Search input (real-time)
   - Filter checkboxes (Group 1, Group 2)
   - "Add Scout" button (only Admin/Admin Leader)
   - List container with group headers

2. Create scout card component (HTML structure)
   - Card with: Name, Group, Points
   - Edit button (only Admin/Admin Leader)
   - Inline edit form (hidden by default)

3. Implement data fetching
   - `loadScouts()` - Fetch scouts from Supabase
   - Handle RLS filtering (user sees only their groups)
   - Sort: Group 1 first, then Group 2, alphabetical within group

4. Implement search functionality
   - Real-time search as user types
   - Filter by name (case-insensitive)
   - Update list immediately

5. Implement filter functionality
   - Filter by scout group (checkboxes)
   - Combine with search (search within filtered results)
   - Update list when filter changes

6. Render scouts list
   - Group by scout_group
   - Show group header ("Group 1", "Group 2")
   - Render cards alphabetically within each group
   - Show empty state if no scouts

7. Add loading states
   - Loading spinner while fetching
   - Error message if fetch fails

**Verification:**
- Scouts list displays correctly
- Search works in real-time
- Filter by group works
- Cards grouped by scout group
- Points displayed on cards
- Empty state shown when no scouts
- Loading/error states work

**Files to modify:**
- `index.html` - Add scouts screen HTML
- `app.js` - Add scouts list logic, search/filter functions
- `styles.css` - Add card styles, list styles, group header styles

---

### Task 3: Build Add Scout Form

**Objective:** Form to add new scout with validation

**Steps:**
1. Create add scout form (modal or inline)
   - Fields: name (required), email (required), scout_group (required, radio/select)
   - Optional: notes, parent_contact
   - Submit button, Cancel button

2. Implement form validation
   - Name: Required, non-empty
   - Email: Required, valid email format, unique (check against existing)
   - Scout Group: Required, must be "Group 1" or "Group 2"
   - Real-time validation (on blur or after typing)

3. Implement error display
   - Inline errors under each field (red text, field border)
   - Error banner at top of form (general errors, API errors)
   - Clear errors on field change

4. Implement duplicate email check
   - Check if email exists in scouts table before submit
   - Show error: "Email already exists"
   - Prevent form submission if duplicate

5. Implement form submission
   - `addScout()` - Insert into Supabase scouts table
   - Handle success: Show success message, redirect to scouts list
   - Handle error: Show error banner
   - Loading state during submission

6. Add form reset
   - Clear form after successful submission
   - Reset validation state

**Verification:**
- Form displays correctly
- Validation works (required fields, email format)
- Duplicate email prevented
- Error messages display correctly
- Form submits successfully
- Redirects to list after add
- Loading states work

**Files to modify:**
- `index.html` - Add add scout form HTML
- `app.js` - Add form validation, submission logic
- `styles.css` - Add form styles, error styles

---

### Task 4: Build Edit Scout Functionality

**Objective:** Inline edit for scout information

**Steps:**
1. Add edit button to scout card
   - Only visible to Admin/Admin Leader
   - Click handler to enable edit mode

2. Implement inline edit form
   - Convert card to editable form
   - Fields: name, email, scout_group (same as add form)
   - Optional: notes, parent_contact
   - Save button, Cancel button

3. Implement edit validation
   - Same validation as add form
   - Check email uniqueness (exclude current scout)
   - Real-time validation

4. Implement edit submission
   - `updateScout()` - Update scout in Supabase
   - Handle success: Update card in place, exit edit mode
   - Handle error: Show error message
   - Loading state during update

5. Implement cancel edit
   - Revert to original values
   - Exit edit mode
   - Clear validation errors

**Verification:**
- Edit button works
- Inline edit form appears
- Validation works
- Update successful
- Card updates in place
- Cancel works correctly

**Files to modify:**
- `index.html` - Add edit form structure (can reuse add form)
- `app.js` - Add edit logic, update function
- `styles.css` - Add edit mode styles

---

### Task 5: Build Leaders List Screen

**Objective:** Display leaders in card format, grouped by scout group, with search/filter

**Steps:**
1. Create leaders list container in `#leaders-screen`
   - Search input (real-time)
   - Filter checkboxes (Group 1, Group 2)
   - "Add Leader" button (only Admin/Admin Leader)
   - List container with group headers

2. Create leader card component (HTML structure)
   - Card with: Name, Group(s), Role
   - Edit button (only Admin/Admin Leader)
   - Inline edit form (hidden by default)

3. Implement data fetching
   - `loadLeaders()` - Fetch leaders from Supabase
   - Handle RLS filtering (user sees only their groups)
   - Sort: Group 1 first, then Group 2, alphabetical within group
   - Handle multi-group leaders (show in each group they belong to)

4. Implement search functionality
   - Real-time search as user types
   - Filter by name (case-insensitive)
   - Update list immediately

5. Implement filter functionality
   - Filter by scout group (checkboxes)
   - Combine with search
   - Update list when filter changes

6. Render leaders list
   - Group by scout_group (leaders appear in each group)
   - Show group header
   - Render cards alphabetically within each group
   - Show empty state if no leaders

7. Add loading states
   - Loading spinner while fetching
   - Error message if fetch fails

**Verification:**
- Leaders list displays correctly
- Search works in real-time
- Filter by group works
- Cards grouped by scout group
- Role displayed on cards
- Multi-group leaders appear in both groups
- Empty state shown when no leaders
- Loading/error states work

**Files to modify:**
- `index.html` - Add leaders screen HTML
- `app.js` - Add leaders list logic, search/filter functions
- `styles.css` - Add leader card styles

---

### Task 6: Build Add Leader Form

**Objective:** Form to add new leader with role assignment (Admin only)

**Steps:**
1. Create add leader form (modal or inline)
   - Fields: name (required), email (required)
   - Scout groups: Checkboxes (Group 1, Group 2) - at least one required
   - Role: Dropdown (Admin, Admin Leader, Leader, Viewer) - only Admin can set
   - Optional: notes
   - Submit button, Cancel button

2. Implement permission-based form
   - If Admin: Role dropdown enabled
   - If Admin Leader: Role field disabled, defaults to "Leader"
   - Show helper text: "Only Admin can assign roles"

3. Implement form validation
   - Name: Required, non-empty
   - Email: Required, valid email format, unique (check against existing)
   - Scout Groups: At least one must be selected
   - Role: Required (but only Admin can set)
   - Real-time validation

4. Implement error display
   - Inline errors under each field
   - Error banner at top of form
   - Clear errors on field change

5. Implement duplicate email check
   - Check if email exists in leaders table before submit
   - Show error: "Email already exists"
   - Prevent form submission if duplicate

6. Implement form submission
   - `addLeader()` - Insert into Supabase leaders table
   - If Admin: Also insert into roles table with selected role
   - If Admin Leader: Insert into roles table with "Leader" role
   - Handle success: Show success message, redirect to leaders list
   - Handle error: Show error banner
   - Loading state during submission

7. Add form reset
   - Clear form after successful submission
   - Reset validation state

**Verification:**
- Form displays correctly
- Permission-based form works (Admin vs Admin Leader)
- Validation works
- Duplicate email prevented
- Error messages display correctly
- Form submits successfully (creates leader and role)
- Redirects to list after add
- Loading states work

**Files to modify:**
- `index.html` - Add add leader form HTML
- `app.js` - Add form validation, submission logic, permission checks
- `styles.css` - Add form styles

---

### Task 7: Build Edit Leader Functionality

**Objective:** Inline edit for leader information (role change: Admin only)

**Steps:**
1. Add edit button to leader card
   - Only visible to Admin/Admin Leader
   - Click handler to enable edit mode

2. Implement inline edit form
   - Convert card to editable form
   - Fields: name, email, scout_groups (checkboxes)
   - Role: Dropdown (only Admin can edit)
   - Optional: notes
   - Save button, Cancel button

3. Implement permission-based edit
   - If Admin: Role dropdown enabled
   - If Admin Leader: Role field disabled (read-only)
   - Show helper text if role disabled

4. Implement edit validation
   - Same validation as add form
   - Check email uniqueness (exclude current leader)
   - At least one scout group required
   - Real-time validation

5. Implement edit submission
   - `updateLeader()` - Update leader in Supabase
   - If Admin and role changed: Update roles table
   - Handle success: Update card in place, exit edit mode
   - Handle error: Show error message
   - Loading state during update

6. Implement cancel edit
   - Revert to original values
   - Exit edit mode
   - Clear validation errors

**Verification:**
- Edit button works
- Inline edit form appears
- Permission-based edit works (Admin vs Admin Leader)
- Validation works
- Update successful (leader and role if changed)
- Card updates in place
- Cancel works correctly

**Files to modify:**
- `index.html` - Add edit form structure
- `app.js` - Add edit logic, update function, role update logic
- `styles.css` - Add edit mode styles

---

### Task 8: Add Permission Checks & UI Hiding

**Objective:** Hide features based on user role

**Steps:**
1. Implement role checking
   - `getUserRole()` - Query roles table, cache result
   - `isAdmin()` - Check if Admin
   - `isAdminLeader()` - Check if Admin Leader
   - `canManageParticipants()` - Admin or Admin Leader

2. Hide UI elements based on role
   - "Add Scout" button: Only Admin/Admin Leader
   - "Add Leader" button: Only Admin/Admin Leader
   - Edit buttons on cards: Only Admin/Admin Leader
   - Role field in forms: Only Admin can edit

3. Show appropriate messages
   - Viewers: "Read-only access" message (if they can see the screen)
   - Admin Leaders: "Role assignment requires Admin" helper text

4. Test permission enforcement
   - Test as Admin (full access)
   - Test as Admin Leader (can add/edit, but role disabled)
   - Test as Leader (no add/edit buttons - if they can see screen)
   - Test as Viewer (read-only - if they can see screen)

**Verification:**
- Role checking works correctly
- UI elements hidden/shown based on role
- Permission messages display correctly
- All role scenarios tested

**Files to modify:**
- `app.js` - Add permission check functions, UI hiding logic
- `index.html` - Add conditional classes/data attributes
- `styles.css` - Add hidden/read-only styles

---

## Success Criteria

1. ✅ Admin/Admin Leader can add new scout (name, email, scout_group)
2. ✅ Admin/Admin Leader can edit scout information
3. ✅ Admin/Admin Leader can view list of all scouts with total points
4. ✅ Admin/Admin Leader can search/filter scouts by name and group
5. ✅ Admin/Admin Leader can add new leader with role assignment
6. ✅ Admin/Admin Leader can view list of all leaders
7. ✅ System prevents duplicate scouts (same email)
8. ✅ UI shows appropriate screens based on user role
9. ✅ Cards grouped by scout group, alphabetical within group
10. ✅ Inline edit works for both scouts and leaders
11. ✅ Permission enforcement (Admin only for role assignment)

## Verification Checklist

- [ ] Navigation menu works (Scouts/Leaders tabs)
- [ ] Scouts list displays with cards grouped by group
- [ ] Search works in real-time for scouts
- [ ] Filter by group works for scouts
- [ ] Add scout form validates correctly
- [ ] Duplicate email prevented for scouts
- [ ] Edit scout works (inline edit)
- [ ] Leaders list displays with cards grouped by group
- [ ] Search works in real-time for leaders
- [ ] Filter by group works for leaders
- [ ] Add leader form validates correctly
- [ ] Role assignment works (Admin only)
- [ ] Duplicate email prevented for leaders
- [ ] Edit leader works (inline edit)
- [ ] Permission checks work (UI hiding)
- [ ] Points displayed on scout cards
- [ ] Multi-group leaders appear in both groups

## Notes

- **Screen Pattern:** Follow existing screen-based navigation (no routing)
- **State Management:** Use simple variables in app.js (extend existing pattern)
- **Form Pattern:** Modal or inline form (decide during implementation)
- **Card Component:** Reusable card structure for scouts and leaders
- **Validation:** Client-side validation + Supabase constraints
- **Error Handling:** Inline errors + banner (both approaches)
- **Permission:** Check role on page load, cache result
- **RLS:** Database-level permissions already enforced (Phase 1)

## Dependencies

- Phase 1 complete (database tables, RLS policies)
- Supabase client initialized (existing)
- User authenticated (existing)

## Estimated Effort

- Task 1 (Navigation): 1-2 hours
- Task 2 (Scouts List): 2-3 hours
- Task 3 (Add Scout): 2-3 hours
- Task 4 (Edit Scout): 1-2 hours
- Task 5 (Leaders List): 2-3 hours
- Task 6 (Add Leader): 2-3 hours
- Task 7 (Edit Leader): 1-2 hours
- Task 8 (Permissions): 1 hour

**Total:** 12-19 hours

---
*Plan created: 2025-02-09*  
*Ready for execution*

