# Phase 1 Plan — Database & Permissions Foundation

**Phase:** 1  
**Wave:** 1  
**Goal:** Establish database schema and permission system as security foundation

## Requirements Covered

- DATA-01: Scouts table in Supabase
- DATA-02: Meetings table in Supabase
- DATA-03: Attendance table in Supabase
- DATA-04: Roles table in Supabase
- DATA-05: Unique constraint on (scout_id, meeting_id)
- DATA-06: Foreign keys with appropriate CASCADE rules
- DATA-07: All tables have created_at and updated_at timestamps
- PERM-01: System supports four role types
- PERM-02: User role stored in Supabase (separate roles table)
- PERM-07: Permission checks enforced server-side via Supabase RLS policies

## Tasks

### Task 1: Create Database Tables

**Objective:** Create all required tables in Supabase with proper schema

**Steps:**
1. Create `roles` table
   - id (UUID, PK, default gen_random_uuid())
   - user_id (UUID, FK to auth.users, UNIQUE, ON DELETE CASCADE)
   - role (TEXT, NOT NULL, CHECK constraint: 'Admin', 'Admin Leader', 'Leader', 'Viewer')
   - created_at (TIMESTAMPTZ, default NOW())
   - Index on user_id for performance

2. Create `scouts` table
   - id (UUID, PK, default gen_random_uuid())
   - name (TEXT, NOT NULL)
   - email (TEXT, UNIQUE, NOT NULL)
   - scout_group (TEXT, NOT NULL, CHECK constraint: 'Group 1' or 'Group 2')
   - points_total (INTEGER, default 0)
   - created_at (TIMESTAMPTZ, default NOW())
   - updated_at (TIMESTAMPTZ, default NOW())
   - Index on scout_group for filtering

3. Create `leaders` table
   - id (UUID, PK, default gen_random_uuid())
   - user_id (UUID, FK to auth.users, UNIQUE)
   - name (TEXT, NOT NULL)
   - email (TEXT, UNIQUE, NOT NULL)
   - scout_groups (TEXT[], array of group names, can have 2 groups)
   - notes (TEXT, optional)
   - active (BOOLEAN, default TRUE)
   - created_at (TIMESTAMPTZ, default NOW())
   - updated_at (TIMESTAMPTZ, default NOW())
   - Index on user_id, GIN index on scout_groups array

4. Create `meetings` table
   - id (UUID, PK, default gen_random_uuid())
   - date (DATE, NOT NULL)
   - location (TEXT)
   - type (TEXT, optional)
   - assigned_leaders (UUID[], array of leader IDs)
   - created_at (TIMESTAMPTZ, default NOW())
   - updated_at (TIMESTAMPTZ, default NOW())
   - Index on date for chronological queries

5. Create `attendance` table
   - id (UUID, PK, default gen_random_uuid())
   - scout_id (UUID, FK to scouts)
   - meeting_id (UUID, FK to meetings)
   - leader_id (UUID, FK to leaders, optional - can be inactive)
   - status (TEXT, NOT NULL, CHECK constraint: 'Present' or 'Absent')
   - points_earned (INTEGER, default 0)
   - recorded_by (UUID, FK to auth.users)
   - recorded_at (TIMESTAMPTZ, default NOW())
   - UNIQUE constraint on (scout_id, meeting_id)
   - Indexes on meeting_id, scout_id for query performance

**Verification:**
- All tables created in Supabase
- All constraints and indexes applied
- Foreign keys properly configured
- Unique constraints in place

**Files to create:**
- `supabase/migrations/001_create_tables.sql` (or apply via Supabase SQL Editor)

---

### Task 2: Create Helper Functions

**Objective:** Create PostgreSQL functions to support RLS policies

**Steps:**
1. Create `get_user_role(user_uuid UUID)` function
   - Returns user's role from roles table
   - Returns NULL if no role found
   - Used in RLS policies for role checking

2. Create `get_user_groups(user_uuid UUID)` function
   - Returns array of scout groups for a leader
   - Queries leaders table for user's scout_groups
   - Returns empty array if not a leader or inactive
   - Uses SECURITY DEFINER to access leaders table
   - Used in RLS policies for group-based filtering

3. Create `is_admin(user_uuid UUID)` function
   - Returns boolean: true if user is Admin
   - Convenience function for RLS policies
   - Uses get_user_role internally

**Verification:**
- Functions created and tested
- Functions return correct values
- SECURITY DEFINER properly configured

**Files to create:**
- `supabase/migrations/002_create_functions.sql` (or apply via Supabase SQL Editor)

---

### Task 3: Create RLS Policies

**Objective:** Enforce role-based and group-based access control at database level

**Steps:**
1. Enable RLS on all tables
   - ALTER TABLE ... ENABLE ROW LEVEL SECURITY

2. Create RLS policies for `scouts` table
   - **Admin SELECT:** Admin can see all scouts
   - **Admin INSERT/UPDATE/DELETE:** Admin can do everything
   - **Admin Leader SELECT:** Admin Leaders can see all scouts
   - **Admin Leader INSERT/UPDATE:** Admin Leaders can edit scouts in their assigned groups
   - **Leader SELECT:** Leaders can see scouts in their assigned group(s)
   - **Viewer SELECT:** Viewers can see scouts in their assigned group (read-only)
   - **No write access:** Leaders and Viewers cannot insert/update/delete

3. Create RLS policies for `leaders` table
   - **Admin:** Full access (see all, edit all)
   - **Admin Leader:** Can see all, edit leaders in their assigned groups
   - **Leader:** Can see leaders in their assigned group(s) (read-only)
   - **Viewer:** Can see leaders in their assigned group (read-only)

4. Create RLS policies for `meetings` table
   - **Admin:** Full access
   - **Admin Leader:** Can see all, create/edit meetings
   - **Leader:** Can see meetings (read-only, filtered by group if needed)
   - **Viewer:** Can see meetings in their assigned group (read-only)

5. Create RLS policies for `attendance` table
   - **Admin:** Full access
   - **Admin Leader:** Can see all, create/edit attendance
   - **Leader:** Can see/create/edit attendance for their assigned group(s)
   - **Viewer:** Can see attendance in their assigned group (read-only)

6. Create RLS policies for `roles` table
   - **Admin:** Can see all roles, can insert/update (but not create another Admin)
   - **Others:** Can only see their own role (read-only)

**Policy Pattern:**
```sql
-- Example: Admin sees all scouts
CREATE POLICY "admin_select_scouts"
ON scouts FOR SELECT
TO authenticated
USING (is_admin(auth.uid()));

-- Example: Leaders see their groups
CREATE POLICY "leader_select_scouts"
ON scouts FOR SELECT
TO authenticated
USING (
  get_user_role(auth.uid()) = 'Leader'
  AND scout_group = ANY(get_user_groups(auth.uid()))
);
```

**Verification:**
- RLS enabled on all tables
- Policies created for each role and operation
- Policies tested with different user roles
- Group isolation verified (Leader can't see other groups)

**Files to create:**
- `supabase/migrations/003_create_rls_policies.sql` (or apply via Supabase SQL Editor)

---

### Task 4: Set Up Initial Admin

**Objective:** Manually create Admin role for danielmilad3621@gmail.com

**Steps:**
1. Find user_id from auth.users table
   - Query: `SELECT id FROM auth.users WHERE email = 'danielmilad3621@gmail.com';`
   - Note the user_id UUID

2. Insert Admin role
   - INSERT INTO roles (user_id, role) VALUES ('<user_id>', 'Admin');
   - Verify: SELECT * FROM roles WHERE role = 'Admin';

3. Verify Admin access
   - Test that Admin can query all tables
   - Test that Admin bypasses group restrictions

**Verification:**
- Admin role exists in roles table
- Admin user_id matches danielmilad3621@gmail.com
- Admin can access all data (test queries)

**Files to create:**
- `supabase/migrations/004_setup_admin.sql` (or apply via Supabase SQL Editor)
- **Note:** This is a one-time setup, not a repeatable migration

---

### Task 5: Test Permission System

**Objective:** Verify RLS policies work correctly for all roles

**Steps:**
1. Create test users (if needed)
   - Create test Admin Leader user
   - Create test Leader user (assigned to Group 1)
   - Create test Viewer user (assigned to Group 1)
   - Create test Leader user (assigned to Group 2)

2. Test Admin access
   - Admin can see all scouts (both groups)
   - Admin can see all leaders
   - Admin can see all meetings
   - Admin can see all attendance records
   - Admin can insert/update/delete (test with sample data)

3. Test Admin Leader access
   - Admin Leader can see all groups
   - Admin Leader can create meetings
   - Admin Leader can edit scouts/leaders in their assigned groups
   - Admin Leader cannot assign roles (test attempted insert to roles table)

4. Test Leader access
   - Leader can only see scouts in their assigned group(s)
   - Leader cannot see scouts in other groups
   - Leader can take attendance (insert into attendance table)
   - Leader cannot create meetings
   - Leader cannot edit scouts/leaders

5. Test Viewer access
   - Viewer can only see their assigned group (read-only)
   - Viewer cannot insert/update/delete anything
   - Viewer cannot see other groups

6. Test group isolation
   - Leader in Group 1 cannot see Group 2 scouts
   - Leader in Group 2 cannot see Group 1 scouts
   - Multi-group leader can see both groups

7. Test inactive leaders
   - Mark leader as active: false
   - Verify attendance records still accessible
   - Verify inactive leader cannot access system (if RLS blocks)

**Verification:**
- All role tests pass
- Group isolation works correctly
- Write permissions enforced correctly
- Admin bypass works

**Files to create:**
- `supabase/migrations/005_test_permissions.sql` (test queries, can be deleted after verification)

---

## Success Criteria

1. ✅ All 5 database tables created (roles, scouts, leaders, meetings, attendance)
2. ✅ All tables have proper constraints (unique, foreign keys, CHECK)
3. ✅ All tables have created_at and updated_at timestamps
4. ✅ Helper functions created (get_user_role, get_user_groups, is_admin)
5. ✅ RLS enabled on all tables
6. ✅ RLS policies enforce role-based access (Admin, Admin Leader, Leader, Viewer)
7. ✅ RLS policies enforce group-based visibility
8. ✅ Admin role created for danielmilad3621@gmail.com
9. ✅ Permission system tested and verified
10. ✅ Unique constraint on (scout_id, meeting_id) prevents duplicates

## Verification Checklist

- [ ] Tables created in Supabase dashboard
- [ ] Foreign keys visible in table relationships
- [ ] Unique constraints visible in table constraints
- [ ] Indexes created (check in Supabase)
- [ ] Functions created and testable
- [ ] RLS enabled (check table settings)
- [ ] Policies visible in Supabase RLS editor
- [ ] Admin role exists and accessible
- [ ] Test queries confirm permission enforcement
- [ ] Group isolation verified

## Notes

- **Migration Strategy:** Apply SQL via Supabase SQL Editor or create migration files
- **Testing:** Use Supabase SQL Editor to test queries with different user contexts
- **Admin Setup:** One-time manual operation, document the user_id for reference
- **Group Names:** Currently 'Group 1' and 'Group 2' - can be customized later
- **Array Fields:** PostgreSQL TEXT[] for multi-group leaders, use array operators in queries

## Dependencies

- Supabase project access
- SQL Editor access in Supabase dashboard
- Admin email: danielmilad3621@gmail.com must exist in auth.users

## Estimated Effort

- Task 1 (Tables): 1-2 hours
- Task 2 (Functions): 30 minutes
- Task 3 (RLS Policies): 2-3 hours
- Task 4 (Admin Setup): 15 minutes
- Task 5 (Testing): 1-2 hours

**Total:** 5-8 hours

---
*Plan created: 2025-02-09*  
*Ready for execution*

