# Phase 5 Plan — Points System

**Phase:** 5  
**Wave:** 1  
**Goal:** Verify, complete, and refine the points system to ensure all requirements are met

## Requirements Covered

- POINT-01: System automatically awards 1 point when scout marked Present ✅ (Phase 4)
- POINT-02: System automatically awards 1 point when leader marked Present ⚠️ (Deferred - leader attendance not persisted)
- POINT-03: Admin/Admin Leader can award additional activity points during meeting ✅ (Phase 4)
- POINT-04: System calculates total points per scout (meeting points + activity points) ✅ (Phase 4)
- POINT-05: System tracks points cumulatively (total increases over time) ✅ (Phase 4)
- POINT-06: System displays scout's total points in participant list ✅ (Phase 2)
- POINT-07: System recalculates points when attendance status changes ✅ (Phase 4)
- POINT-08: Points are tracking-only (not redeemable in v1) ✅ (No redemption functionality)

## Tasks

### Task 1: Verify Points Requirements

**Objective:** Review and test all points requirements to ensure they're met

**Steps:**
1. Review POINT-01: Scout Present = 1 point
   - Test: Mark scout as Present → verify 1 point added
   - Test: Mark scout as Absent → verify 0 points (or points removed if previously Present)
   - Verify: `points_earned = 1` in attendance record
   - Verify: `points_total` increases by 1

2. Review POINT-02: Leader Present = 1 point
   - Document: Leader attendance not persisted in v1
   - Note: Leader points not tracked (consistent with leader attendance limitation)
   - Update requirements status: Deferred to v2

3. Review POINT-03: Activity points input
   - Test: Enter activity points → verify saved
   - Test: Activity points added to base points
   - Verify: `points_earned = 1 + activity_points` in attendance record

4. Review POINT-04: Total points calculation
   - Test: Present + activity points → verify total correct
   - Verify: Formula: `points_earned = (Present ? 1 : 0) + activity_points`

5. Review POINT-05: Cumulative tracking
   - Test: Multiple meetings → verify points accumulate
   - Verify: `points_total` increases over time
   - Test: Change attendance status → verify points recalculated

6. Review POINT-06: Points display
   - Verify: Points shown in scouts list
   - Verify: Points update after attendance saved
   - Test: Refresh page → verify points persist

7. Review POINT-07: Recalculation on status change
   - Test: Present → Absent → verify points removed
   - Test: Absent → Present → verify points added
   - Test: Change activity points → verify points updated

8. Review POINT-08: Tracking-only
   - Verify: No redemption functionality exists
   - Document: Points are for tracking only

**Verification:**
- All requirements tested and verified
- Any gaps documented
- Requirements status updated

**Files to modify:**
- `.planning/REQUIREMENTS.md` - Update POINT-02 status

---

### Task 2: Add Points Recalculation Function

**Objective:** Add admin function to recalculate points_total from attendance records

**Steps:**
1. Create recalculation function
   - `recalculateAllPoints()` - Recalculate points for all scouts
   - Query all attendance records
   - Group by scout_id
   - Sum points_earned for each scout
   - Update scouts.points_total

2. Add admin-only UI button
   - Add "Recalculate Points" button to scouts screen (Admin only)
   - Show confirmation dialog before recalculation
   - Show progress indicator during recalculation
   - Show success/error message

3. Implement recalculation logic
   - Query: `SELECT scout_id, SUM(points_earned) FROM attendance GROUP BY scout_id`
   - For each scout: `UPDATE scouts SET points_total = calculated_total WHERE id = scout_id`
   - Handle scouts with no attendance (set to 0)

4. Add error handling
   - Catch errors during recalculation
   - Show error message if fails
   - Allow retry

5. Add validation
   - Verify points_total matches sum of attendance records
   - Log any discrepancies
   - Show summary after recalculation

**Verification:**
- Recalculation function works correctly
- Points_total matches sum of attendance records
- Admin-only access enforced
- Error handling works

**Files to modify:**
- `app.js` - Add recalculation function
- `index.html` - Add recalculation button (Admin only)
- `styles.css` - Button styles (if needed)

---

### Task 3: Verify Points Display

**Objective:** Ensure points display correctly in all views

**Steps:**
1. Verify scouts list display
   - Check: Points shown in scout cards
   - Check: Points update after attendance saved
   - Test: Refresh page → verify points persist

2. Verify attendance screen display
   - Check: Activity points input shows current value
   - Check: Points update after save
   - Verify: Points display in feedback (if shown)

3. Test points update flow
   - Mark attendance → verify points update in scouts list
   - Change activity points → verify points update
   - Change status → verify points recalculate

4. Add points refresh after save
   - After saving attendance, refresh scouts list if visible
   - Or update points display in real-time
   - Ensure UI stays in sync

**Verification:**
- Points display correctly in all views
- Points update in real-time after save
- Points persist after refresh

**Files to modify:**
- `app.js` - Add points refresh logic (if needed)

---

### Task 4: Handle Edge Cases

**Objective:** Add validation and handle edge cases for points

**Steps:**
1. Negative points prevention
   - Verify: `Math.max(0, newTotal)` prevents negative points
   - Test: Change Present → Absent when points_total = 0
   - Verify: Points don't go negative

2. Points validation
   - Validate: `points_earned >= 0`
   - Validate: `points_total >= 0`
   - Validate: Activity points >= 0

3. Handle deleted attendance
   - If attendance record deleted, points should be recalculated
   - Note: CASCADE rules handle this (attendance deletion removes points)
   - Document: Points integrity maintained

4. Handle deleted scout
   - If scout deleted, attendance records handled by CASCADE
   - Points_total removed with scout
   - Document: CASCADE rules handle this

5. Handle duplicate attendance (prevented)
   - Unique constraint prevents duplicates
   - Document: No duplicate attendance possible

6. Handle missing attendance records
   - If scout has points_total but no attendance records
   - Recalculation will set to 0
   - Document: Recalculation fixes this

**Verification:**
- All edge cases handled
- Validation prevents invalid data
- Edge cases documented

**Files to modify:**
- `app.js` - Add validation (if needed)
- `.planning/phases/05-points-system/05-01-SUMMARY.md` - Document edge cases

---

### Task 5: Document Leader Points Limitation

**Objective:** Document that leader points are not tracked in v1

**Steps:**
1. Update requirements status
   - Mark POINT-02 as "Deferred to v2"
   - Note: Leader attendance not persisted, so leader points not tracked
   - Consistent with leader attendance limitation

2. Add note in code
   - Comment in attendance code about leader points
   - Note: Leader points not tracked in v1

3. Update documentation
   - Update Phase 5 summary with limitation
   - Update STATE.md with known limitations
   - Note: Leader points will be added in v2 when leader attendance is persisted

**Verification:**
- Requirements status updated
- Limitation documented
- Consistent with leader attendance limitation

**Files to modify:**
- `.planning/REQUIREMENTS.md` - Update POINT-02 status
- `.planning/phases/05-points-system/05-01-SUMMARY.md` - Document limitation
- `.planning/STATE.md` - Add to known limitations

---

## Success Criteria

1. ✅ All points requirements verified and working (except POINT-02 deferred)
2. ✅ Points recalculation function available for admins
3. ✅ Points display correctly in all views
4. ✅ Edge cases handled (negative points, validation, etc.)
5. ✅ Leader points limitation documented
6. ✅ Points system is reliable and data integrity maintained

## Verification Checklist

- [ ] POINT-01: Scout Present = 1 point (tested and verified)
- [ ] POINT-02: Leader Present = 1 point (deferred to v2, documented)
- [ ] POINT-03: Activity points input (tested and verified)
- [ ] POINT-04: Total points calculation (tested and verified)
- [ ] POINT-05: Cumulative tracking (tested and verified)
- [ ] POINT-06: Points display in lists (tested and verified)
- [ ] POINT-07: Recalculation on status change (tested and verified)
- [ ] POINT-08: Tracking-only (verified - no redemption)
- [ ] Points recalculation function works
- [ ] Points display updates correctly
- [ ] Edge cases handled
- [ ] Leader points limitation documented

## Notes

- **Most points functionality already implemented in Phase 4**
- **Phase 5 focuses on verification, completion, and data integrity**
- **Leader points deferred to v2** (consistent with leader attendance limitation)
- **Points recalculation** adds data integrity safety net
- **Edge cases** ensure system reliability

## Dependencies

- Phase 4 complete (attendance taking with points)
- Phase 2 complete (scouts list with points display)

## Estimated Effort

- Task 1 (Verify Requirements): 1-2 hours
- Task 2 (Recalculation Function): 2-3 hours
- Task 3 (Verify Display): 1 hour
- Task 4 (Edge Cases): 1-2 hours
- Task 5 (Documentation): 30 minutes

**Total:** 5.5-8.5 hours

---
*Plan created: 2025-02-09*  
*Ready for execution*

